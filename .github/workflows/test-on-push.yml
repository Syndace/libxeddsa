name: test-on-push

on: [push]

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1.3

    - name: Install libsodium, a dependency of python-xeddsa
      shell: bash
      run: |
        curl -o libsodium-1.0.18-stable-msvc.zip https://download.libsodium.org/libsodium/releases/libsodium-1.0.18-stable-msvc.zip
        unzip libsodium-1.0.18-stable-msvc.zip

    - name: Run cmake
      shell: bash
      run: |
        export sodium_DIR="$(pwd)/libsodium/"
        mkdir build/
        cd build/
        cmake -T host=x64 -A x64 ..

    - name: Run MSBuild
      run: |
        cd build
        msbuild libxeddsa.sln

    - name: Run ctest in Debug configuration
      run: |
        cd build
        ctest -C Debug ..

    - name: Run ctest in Release configuration
      run: |
        cd build
        ctest -C Release ..

  build-ubuntu-macos:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - uses: actions/checkout@v3

    - name: Install libsodium, a dependency of python-xeddsa, on ubuntu-latest
      run: sudo apt-get install -y libsodium-dev
      if: matrix.os == 'ubuntu-latest'

    - name: Install libsodium, a dependency of python-xeddsa, on macos-latest
      run: brew install libsodium
      if: matrix.os == 'macos-latest'

    - name: Run cmake
      run: |
        mkdir build/
        cd build/
        cmake ..

    - name: Run make
      run: |
        cd build/
        make

    - name: Run ctest
      run: |
        cd build/
        ctest ..
